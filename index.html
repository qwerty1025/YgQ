<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>阿順和 秦佳圓的記帳 (Pro)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6B46C1;
            --secondary: #319795;
            --warning: #D69E2E;
            --info: #3182CE;
            --bg-gray: #F7FAFC;
        }

        body { 
            background-color: var(--bg-gray); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #2D3748;
            -webkit-tap-highlight-color: transparent;
        }

        .font-num { font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace; letter-spacing: -0.5px; }

        /* 表格樣式 */
        .excel-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .excel-table th { background-color: var(--primary); color: white; padding: 12px 8px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        .excel-table td { padding: 12px 8px; border-bottom: 1px solid #E2E8F0; vertical-align: middle; }
        .excel-table tr:nth-child(even) { background-color: #fff; }
        .excel-table tr:nth-child(odd) { background-color: #FAFAFA; }

        /* 價格表樣式 */
        .price-table th { background-color: #4A5568; }

        /* 狀態文字 */
        .text-pos { color: var(--secondary); font-weight: bold; }
        .text-neg { color: #E53E3E; font-weight: bold; }

        /* 按鈕區 */
        .action-bar { box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); }
        
        /* 刪除按鈕隱藏與顯示 */
        .row-action-btn { opacity: 0.3; transition: opacity 0.2s; }
        tr:hover .row-action-btn { opacity: 1; }
    </style>
</head>
<body class="h-screen flex flex-col">

<div id="app" class="flex flex-col h-full max-w-2xl mx-auto w-full bg-white shadow-2xl">

    <header class="p-5 shrink-0 shadow-md z-20 transition-colors duration-300" 
        :class="headerClass">
        <div class="flex justify-between items-start text-white">
            <div>
                <h1 class="text-xl font-bold opacity-90 flex items-center gap-2">
                    <i class="fa-solid fa-calculator"></i> 阿順與佳圓
                </h1>
                <p class="text-white/70 text-sm mt-1">目前分頁: {{ currentTabName }}</p>
            </div>
            <div class="text-right">
                <div class="text-white/70 text-xs uppercase tracking-wider">目前總餘額</div>
                <div class="text-4xl font-bold font-num mt-1">${{ formatNumber(currentBalance) }}</div>
            </div>
        </div>

        <div class="flex mt-4 bg-black/20 p-1 rounded-lg overflow-x-auto gap-1 no-scrollbar">
            <button v-for="tab in tabs" :key="tab.id" @click="viewMode = tab.id" 
                class="flex-none px-4 py-2 rounded-md text-sm font-bold transition-all duration-200 whitespace-nowrap"
                :class="viewMode === tab.id ? 'bg-white text-gray-800 shadow' : 'text-white/70 hover:bg-white/10'">
                <i :class="tab.icon" class="mr-1"></i>{{ tab.name }}
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto bg-gray-50 relative scroll-smooth">
        
        <div v-if="transactions.length === 0 && dbReady" class="flex flex-col items-center justify-center h-full p-8 text-center">
            <div class="bg-white p-8 rounded-2xl shadow-lg border border-purple-100 max-w-xs">
                <div class="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-purple-600 text-2xl">
                    <i class="fa-solid fa-file-import"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">準備就緒</h3>
                <button @click="importInitialData" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
                    載入歷史資料
                </button>
            </div>
        </div>

        <div v-if="viewMode === 'ledger' && transactions.length > 0">
            <table class="excel-table">
                <thead>
                    <tr>
                        <th class="w-1/5 pl-4">日期</th>
                        <th class="w-2/5">項目</th>
                        <th class="w-1/5 text-right">金額</th>
                        <th class="w-1/6 text-right pr-2">餘額</th>
                        <th class="w-8"></th> </tr>
                </thead>
                <tbody>
                    <tr v-for="t in sortedTransactions" :key="t.id" :class="{'bg-yellow-50': t.type === 'exception'}">
                        <td class="pl-4 border-r border-gray-100">
                            <div class="font-bold text-gray-700">{{ formatDate(t.date) }}</div>
                            <div class="text-xs text-gray-400 font-num">{{ getWeekDay(t.date) }}</div>
                        </td>
                        <td>
                            <div v-if="t.type === 'deposit'" class="flex items-center text-teal-600 font-bold">
                                <i class="fa-solid fa-coins mr-2 text-yellow-500 text-lg"></i> 
                                {{ t.note || '儲值' }}
                            </div>
                            <div v-else-if="t.type === 'exception'" class="text-amber-700 font-bold text-sm">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i> {{ t.note }}
                            </div>
                            <div v-else>
                                <div class="flex flex-wrap gap-1">
                                    <span v-if="t.small > 0" class="bg-blue-50 text-blue-700 px-2 rounded border border-blue-200 text-xs font-bold">小{{ t.small }}</span>
                                    <span v-if="t.large > 0" class="bg-orange-50 text-orange-700 px-2 rounded border border-orange-200 text-xs font-bold">大{{ t.large }}</span>
                                    <span v-if="t.note" class="text-xs text-gray-400">({{t.note}})</span>
                                </div>
                            </div>
                        </td>
                        <td class="text-right font-num text-lg">
                            <span :class="getAmountColor(t)">
                                {{ getSign(t) }}{{ Math.abs(t.amount) }}
                            </span>
                        </td>
                        <td class="text-right pr-2 font-num font-bold text-gray-500 text-sm">
                            {{ formatNumber(t.runningBalance) }}
                        </td>
                        <td class="text-center">
                            <button @click="deleteTransaction(t.id)" class="row-action-btn text-gray-400 hover:text-red-500 p-2">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="h-24"></div>
        </div>

        <div v-if="viewMode === 'report'" class="p-4 space-y-4">
            <div v-for="(stat, month) in monthlyStats" :key="month" class="bg-white rounded-xl shadow-sm border border-purple-100 overflow-hidden">
                <div class="bg-purple-50 px-4 py-3 border-b border-purple-100">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-purple-900 text-lg">{{ month }}</h3>
                        <span class="text-xs bg-white px-2 py-1 rounded text-purple-800 border border-purple-200 font-bold">
                            淨變動: {{ stat.net >= 0 ? '+' : '' }}{{ formatNumber(stat.net) }}
                        </span>
                    </div>
                    <div class="flex justify-between text-xs text-purple-600 bg-purple-100/50 p-2 rounded">
                        <span>月初: ${{ formatNumber(stat.startBalance) }}</span>
                        <i class="fa-solid fa-arrow-right opacity-50"></i>
                        <span class="font-bold">月底: ${{ formatNumber(stat.endBalance) }}</span>
                    </div>
                </div>
                
                <div class="p-4 grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-2 rounded text-center">
                        <div class="text-xs text-blue-500 mb-1">小羊奶</div>
                        <div class="text-xl font-bold font-num text-blue-700">{{ stat.totalSmall }}</div>
                    </div>
                    <div class="bg-orange-50 p-2 rounded text-center">
                        <div class="text-xs text-orange-500 mb-1">大羊奶</div>
                        <div class="text-xl font-bold font-num text-orange-700">{{ stat.totalLarge }}</div>
                    </div>
                    <div class="col-span-2 flex justify-between items-center border-t border-dashed pt-2">
                        <span class="text-gray-500 text-sm">本月支出</span>
                        <span class="text-red-500 font-bold font-num">${{ formatNumber(stat.expense) }}</span>
                    </div>
                    <div class="col-span-2 flex justify-between items-center">
                        <span class="text-gray-500 text-sm">本月儲值</span>
                        <span class="text-teal-600 font-bold font-num">${{ formatNumber(stat.deposit) }}</span>
                    </div>
                </div>
            </div>
            <div class="h-24"></div>
        </div>

        <div v-if="viewMode === 'exception'" class="bg-gray-50 min-h-full">
            <div class="p-4 bg-amber-50 border-b border-amber-200">
                <h2 class="text-amber-800 font-bold text-lg">例外項目清單</h2>
                <p class="text-amber-700 text-sm">用於修正計算誤差或手動調整。</p>
            </div>
            <div class="bg-white">
                 <div v-for="t in exceptionTransactions" :key="t.id" class="p-4 border-b flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-800">{{ t.note }}</div>
                        <div class="text-xs text-gray-400">{{ formatDate(t.date) }}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold font-num text-lg" :class="t.amount >= 0 ? 'text-teal-600' : 'text-red-600'">
                            {{ t.amount >= 0 ? '+' : '' }}{{ t.amount }}
                        </span>
                        <button @click="deleteTransaction(t.id)" class="text-gray-300 hover:text-red-500">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                 </div>
            </div>
            <div class="p-4">
                 <button @click="openModal('exception')" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold shadow hover:bg-amber-600">
                    <i class="fa-solid fa-plus mr-1"></i> 新增例外調整
                </button>
            </div>
            <div class="h-24"></div>
        </div>

        <div v-if="viewMode === 'copy'" class="p-4 h-full flex flex-col">
            <div class="bg-white rounded-xl shadow p-5 flex-1 flex flex-col">
                <h3 class="font-bold text-lg text-gray-700 mb-2 border-b pb-2">
                    <i class="fa-brands fa-line text-green-500 mr-2"></i>LINE 對帳文字
                </h3>
                <p class="text-sm text-gray-500 mb-4">系統自動抓取「上一筆儲值」之後的所有未結項目。</p>
                
                <textarea readonly class="flex-1 w-full bg-gray-50 border rounded-lg p-3 font-num text-sm text-gray-700 leading-relaxed outline-none resize-none mb-4"
                    :value="unsettledText"></textarea>

                <button @click="copyToClipboard" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">
                    <i class="fa-regular fa-copy"></i> 一鍵複製文字
                </button>
            </div>
            <div class="h-24"></div>
        </div>

        <div v-if="viewMode === 'products'" class="p-4">
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 border-b">
                        <tr>
                            <th class="px-4 py-3">品項</th>
                            <th class="px-4 py-3">價格區間 (日期)</th>
                            <th class="px-4 py-3 text-right">批發價</th>
                            <th class="px-4 py-3 text-right">售價</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3 font-bold text-blue-600">小羊奶</td>
                            <td class="px-4 py-3 text-gray-500">2025/08/16 以前</td>
                            <td class="px-4 py-3 text-right font-num font-bold">$65</td>
                            <td class="px-4 py-3 text-right text-gray-400">-</td>
                        </tr>
                        <tr class="border-b bg-blue-50/50">
                            <td class="px-4 py-3 font-bold text-blue-600">小羊奶</td>
                            <td class="px-4 py-3 font-bold text-green-700">2025/08/17 起</td>
                            <td class="px-4 py-3 text-right font-num font-bold text-red-600">$70</td>
                            <td class="px-4 py-3 text-right text-gray-400">-</td>
                        </tr>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-4 py-3 font-bold text-orange-600">大羊奶</td>
                            <td class="px-4 py-3 text-gray-500">2025/09/29 以前</td>
                            <td class="px-4 py-3 text-right font-num font-bold">$135</td>
                            <td class="px-4 py-3 text-right text-gray-400">-</td>
                        </tr>
                        <tr class="bg-orange-50/50">
                            <td class="px-4 py-3 font-bold text-orange-600">大羊奶</td>
                            <td class="px-4 py-3 font-bold text-green-700">2025/09/30 起</td>
                            <td class="px-4 py-3 text-right font-num font-bold text-red-600">$130</td>
                            <td class="px-4 py-3 text-right text-gray-400">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="text-xs text-gray-400 mt-2 p-1">* 系統計算配送金額時，會依照上述日期自動判斷使用哪個價格。</p>
            <div class="h-24"></div>
        </div>

    </main>

    <div v-if="['ledger', 'report', 'copy'].includes(viewMode)" class="action-bar fixed bottom-0 w-full max-w-2xl p-4 z-30 pb-6 flex gap-3">
        <button @click="openModal('expense')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">
            <i class="fa-solid fa-truck"></i>
            <span class="font-bold text-lg">配送記帳</span>
        </button>
        <button @click="openModal('deposit')" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all">
            <i class="fa-solid fa-sack-dollar"></i>
            <span class="font-bold text-lg">儲值/轉帳</span>
        </button>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-gray-900/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-4 sm:p-0">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            <div class="px-5 py-4 border-b flex justify-between items-center" 
                :class="{'bg-purple-50': modalType==='expense', 'bg-teal-50': modalType==='deposit', 'bg-amber-50': modalType==='exception'}">
                <h3 class="font-bold text-lg flex items-center gap-2" 
                    :class="{'text-purple-800': modalType==='expense', 'text-teal-800': modalType==='deposit', 'text-amber-800': modalType==='exception'}">
                    {{ getModalTitle() }}
                </h3>
                <button @click="showModal = false" class="w-8 h-8 rounded-full bg-white text-gray-500 hover:text-red-500 flex items-center justify-center shadow-sm">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="p-5 space-y-5">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">日期</label>
                    <div class="flex gap-2 mt-1">
                        <input type="date" v-model="form.date" class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-lg font-num font-bold outline-none focus:ring-2 focus:ring-purple-500">
                        <div class="bg-gray-100 px-3 py-2 rounded-lg font-bold text-gray-500 flex items-center justify-center w-16">
                            {{ getWeekDay(form.date) }}
                        </div>
                    </div>
                </div>

                <div v-if="modalType === 'expense'" class="space-y-4">
                    <div class="text-center text-xs text-gray-400 bg-gray-50 rounded p-1 mb-2">
                        當前日期適用價格: 小${{ currentPrices.small }} / 大${{ currentPrices.large }}
                    </div>
                    <div class="flex items-center justify-between bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <span class="text-blue-800 font-bold">小羊奶</span>
                        <div class="flex items-center gap-3">
                            <button @click="form.small = Math.max(0, form.small-1)" class="w-10 h-10 rounded-lg bg-white shadow text-blue-600 font-bold text-xl">-</button>
                            <div class="w-8 text-center font-bold text-xl font-num">{{ form.small }}</div>
                            <button @click="form.small++" class="w-10 h-10 rounded-lg bg-blue-600 shadow text-white font-bold text-xl">+</button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between bg-orange-50 p-3 rounded-lg border border-orange-100">
                        <span class="text-orange-800 font-bold">大羊奶</span>
                        <div class="flex items-center gap-3">
                            <button @click="form.large = Math.max(0, form.large-1)" class="w-10 h-10 rounded-lg bg-white shadow text-orange-600 font-bold text-xl">-</button>
                            <div class="w-8 text-center font-bold text-xl font-num">{{ form.large }}</div>
                            <button @click="form.large++" class="w-10 h-10 rounded-lg bg-orange-600 shadow text-white font-bold text-xl">+</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-dashed">
                        <span class="text-gray-500 font-bold text-sm">小計</span>
                        <span class="text-2xl font-bold font-num text-purple-700">${{ calculateExpense() }}</span>
                    </div>
                </div>

                <div v-if="modalType === 'deposit'">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">金額</label>
                    <input type="number" v-model.number="form.amount" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-3xl font-num font-bold text-teal-600 outline-none" placeholder="0">
                </div>

                <div v-if="modalType === 'exception'">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">調整金額 (+增加 / -減少)</label>
                    <input type="number" v-model.number="form.amount" class="w-full mt-1 bg-amber-50 border border-amber-200 rounded-lg px-4 py-3 text-3xl font-num font-bold text-amber-700 outline-none" placeholder="-3400">
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">備註</label>
                    <input type="text" v-model="form.note" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 outline-none focus:ring-2" placeholder="選填">
                </div>
            </div>

            <div class="p-5 pt-0">
                <button @click="submitTransaction" class="w-full py-3.5 rounded-xl font-bold text-white shadow-lg text-lg transition-transform active:scale-95"
                    :class="{'bg-purple-600': modalType==='expense', 'bg-teal-600': modalType==='deposit', 'bg-amber-500': modalType==='exception'}">
                    確認儲存
                </button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
        authDomain: "crm-ts-1225-001.firebaseapp.com",
        databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
        projectId: "crm-ts-1225-001",
        storageBucket: "crm-ts-1225-001.firebasestorage.app",
        messagingSenderId: "925760221722",
        appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION_NAME = "milk_ledger";

    createApp({
        setup() {
            const dbReady = ref(false);
            const transactions = ref([]);
            const viewMode = ref('ledger');
            const showModal = ref(false);
            const modalType = ref('expense');
            
            // UI 設定
            const tabs = [
                {id: 'ledger', name: '流水帳', icon: 'fa-solid fa-list'},
                {id: 'report', name: '月報表', icon: 'fa-solid fa-chart-pie'},
                {id: 'exception', name: '例外', icon: 'fa-solid fa-triangle-exclamation'},
                {id: 'copy', name: '對帳單', icon: 'fa-brands fa-line'},
                {id: 'products', name: '商品表', icon: 'fa-solid fa-tags'}
            ];

            const form = ref({
                date: new Date().toISOString().split('T')[0],
                small: 0,
                large: 0,
                amount: '',
                note: ''
            });

            // 價格邏輯: 根據日期判斷
            const currentPrices = computed(() => {
                const d = new Date(form.value.date);
                // 小羊奶: 2025/8/17 起漲價為 70
                const smallPrice = d >= new Date('2025-08-17') ? 70 : 65;
                // 大羊奶: 2025/9/30 起降價為 130
                const largePrice = d >= new Date('2025-09-30') ? 130 : 135;
                return { small: smallPrice, large: largePrice };
            });

            const initialData = [
                {date: '2025-03-01', type: 'exception', small: 0, large: 0, amount: 125, note: '期初餘額校正'},
                {date: '2025-03-12', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-03-16', type: 'expense', small: 17, large: 0, amount: 1105, note: ''},
                {date: '2025-03-23', type: 'expense', small: 6, large: 0, amount: 390, note: ''},
                {date: '2025-03-30', type: 'expense', small: 4, large: 1, amount: 395, note: ''},
                {date: '2025-04-12', type: 'expense', small: 10, large: 0, amount: 650, note: ''},
                {date: '2025-04-21', type: 'expense', small: 5, large: 0, amount: 325, note: ''},
                {date: '2025-04-30', type: 'deposit', small: 0, large: 0, amount: 3000, note: '轉帳'},
                {date: '2025-05-01', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-05-04', type: 'expense', small: 8, large: 0, amount: 520, note: ''},
                {date: '2025-05-12', type: 'expense', small: 10, large: 0, amount: 650, note: ''},
                {date: '2025-05-24', type: 'expense', small: 10, large: 0, amount: 650, note: ''},
                {date: '2025-06-01', type: 'expense', small: 11, large: 0, amount: 715, note: ''},
                {date: '2025-06-08', type: 'expense', small: 7, large: 0, amount: 455, note: ''},
                {date: '2025-06-08', type: 'deposit', small: 0, large: 0, amount: 4000, note: '儲值'},
                {date: '2025-06-08', type: 'exception', small: 0, large: 0, amount: -360, note: '手寫帳誤差'},
                {date: '2025-06-15', type: 'expense', small: 7, large: 0, amount: 455, note: ''},
                {date: '2025-06-24', type: 'expense', small: 1, large: 0, amount: 65, note: ''},
                {date: '2025-06-28', type: 'expense', small: 5, large: 0, amount: 325, note: ''},
                {date: '2025-07-06', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-07-20', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-07-29', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-08-01', type: 'expense', small: 2, large: 0, amount: 130, note: ''},
                {date: '2025-08-01', type: 'deposit', small: 0, large: 0, amount: 1290, note: ''},
                {date: '2025-08-01', type: 'exception', small: 0, large: 0, amount: 100, note: '修正誤差'},
                {date: '2025-08-12', type: 'expense', small: 10, large: 0, amount: 650, note: ''},
                {date: '2025-08-17', type: 'expense', small: 4, large: 0, amount: 280, note: ''},
                {date: '2025-08-21', type: 'expense', small: 2, large: 0, amount: 140, note: ''},
                {date: '2025-08-21', type: 'exception', small: 0, large: 0, amount: -5, note: '修正'},
                {date: '2025-08-28', type: 'expense', small: 3, large: 0, amount: 210, note: ''},
                {date: '2025-08-28', type: 'deposit', small: 0, large: 0, amount: 1280, note: ''},
                {date: '2025-09-01', type: 'expense', small: 2, large: 0, amount: 140, note: ''},
                {date: '2025-09-06', type: 'expense', small: 5, large: 0, amount: 350, note: ''},
                {date: '2025-09-16', type: 'expense', small: 4, large: 0, amount: 280, note: ''},
                {date: '2025-09-22', type: 'expense', small: 2, large: 0, amount: 140, note: ''},
                {date: '2025-09-30', type: 'expense', small: 6, large: 2, amount: 680, note: ''},
                {date: '2025-09-30', type: 'exception', small: 0, large: 0, amount: -3400, note: '食農教育款'},
                {date: '2025-09-30', type: 'deposit', small: 0, large: 0, amount: 5000, note: '轉帳'},
                {date: '2025-10-03', type: 'expense', small: 4, large: 0, amount: 280, note: ''},
                {date: '2025-10-12', type: 'expense', small: 6, large: 3, amount: 810, note: ''},
                {date: '2025-10-19', type: 'expense', small: 7, large: 3, amount: 880, note: ''},
                {date: '2025-10-19', type: 'deposit', small: 0, large: 0, amount: 3959, note: ''},
                {date: '2025-10-19', type: 'exception', small: 0, large: 0, amount: -9, note: '尾數捨去'},
                {date: '2025-10-27', type: 'expense', small: 6, large: 4, amount: 940, note: ''},
                {date: '2025-11-03', type: 'expense', small: 10, large: 5, amount: 1350, note: ''},
                {date: '2025-11-03', type: 'deposit', small: 0, large: 0, amount: 1200, note: ''},
                {date: '2025-11-10', type: 'expense', small: 0, large: 4, amount: 520, note: ''},
                {date: '2025-11-17', type: 'expense', small: 11, large: 3, amount: 1160, note: ''},
                {date: '2025-11-17', type: 'deposit', small: 0, large: 0, amount: 4000, note: ''},
                {date: '2025-11-24', type: 'expense', small: 4, large: 6, amount: 1060, note: ''},
                {date: '2025-12-01', type: 'expense', small: 4, large: 4, amount: 800, note: ''},
                {date: '2025-12-06', type: 'expense', small: 13, large: 3, amount: 1300, note: ''},
                {date: '2025-12-09', type: 'expense', small: 2, large: 0, amount: 140, note: ''},
                {date: '2025-12-28', type: 'expense', small: 11, large: 4, amount: 1290, note: ''},
                {date: '2026-01-03', type: 'expense', small: 12, large: 0, amount: 840, note: ''},
                {date: '2026-01-03', type: 'deposit', small: 0, large: 0, amount: 4200, note: ''},
                {date: '2026-01-04', type: 'expense', small: 6, large: 0, amount: 420, note: ''},
            ];

            onMounted(() => {
                const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
                onSnapshot(q, (snapshot) => {
                    transactions.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    dbReady.value = true;
                });
            });

            // 運算邏輯
            const sortedTransactions = computed(() => {
                let items = [...transactions.value].sort((a, b) => {
                    if (a.date === b.date) {
                        if (a.type !== b.type) return (a.type === 'deposit' || a.type === 'exception') ? 1 : -1;
                    }
                    return new Date(a.date) - new Date(b.date);
                });

                let running = 0;
                items.forEach(t => {
                    if (t.type === 'deposit' || t.type === 'exception') running += Number(t.amount);
                    else running -= Number(t.amount);
                    t.runningBalance = running;
                });

                return items.reverse();
            });

            const currentBalance = computed(() => sortedTransactions.value.length ? sortedTransactions.value[0].runningBalance : 0);
            
            // 例外清單
            const exceptionTransactions = computed(() => sortedTransactions.value.filter(t => t.type === 'exception'));

            // 月報表
            const monthlyStats = computed(() => {
                const stats = {};
                // 需要按日期正序計算月初餘額
                const ascTransactions = [...sortedTransactions.value].reverse();
                let running = 0;

                // 預先計算每一筆交易後的餘額，方便抓取
                ascTransactions.forEach(t => {
                    if (t.type === 'deposit' || t.type === 'exception') running += Number(t.amount);
                    else running -= Number(t.amount);
                    t._tempBalance = running;
                });

                ascTransactions.forEach((t, index) => {
                    const d = new Date(t.date);
                    const key = `${d.getFullYear()}年${d.getMonth() + 1}月`;
                    
                    if (!stats[key]) {
                        // 月初餘額 = 這一筆交易之前的餘額 (即上一筆的餘額，如果是第一筆則為0)
                        const prevBalance = index > 0 ? ascTransactions[index-1]._tempBalance : 0;
                        stats[key] = { 
                            totalSmall: 0, totalLarge: 0, expense: 0, deposit: 0, net: 0,
                            startBalance: prevBalance,
                            endBalance: 0
                        };
                    }
                    
                    if (t.type === 'expense') {
                        stats[key].totalSmall += (t.small || 0);
                        stats[key].totalLarge += (t.large || 0);
                        stats[key].expense += Number(t.amount);
                        stats[key].net -= Number(t.amount);
                    } else if (t.type === 'deposit') {
                        stats[key].deposit += Number(t.amount);
                        stats[key].net += Number(t.amount);
                    } else {
                        stats[key].net += Number(t.amount);
                    }
                    
                    // 不斷更新月底餘額，最後一筆會是該月最終餘額
                    stats[key].endBalance = t._tempBalance;
                });
                
                // 反轉物件鍵值以顯示新月份在先 (UI呈現用)
                return stats; 
            });

            // 對帳小幫手文字生成
            const unsettledText = computed(() => {
                const txs = sortedTransactions.value;
                if(txs.length === 0) return "尚無資料";
                
                // 找到最近一次儲值
                const lastDepositIndex = txs.findIndex(t => t.type === 'deposit');
                
                // 取出儲值後的所有消費
                const unsettled = lastDepositIndex === -1 ? txs : txs.slice(0, lastDepositIndex);
                
                // 只看消費與例外，不包含那筆儲值本身
                const validItems = unsettled.filter(t => t.type === 'expense' || t.type === 'exception');
                
                let totalAmount = 0;
                let text = `[阿順對帳單]\n`;
                text += `----------------\n`;
                
                validItems.reverse().forEach(t => {
                    const date = t.date.substring(5).replace('-','/');
                    if (t.type === 'expense') {
                        let desc = '';
                        if(t.small) desc += `小${t.small} `;
                        if(t.large) desc += `大${t.large} `;
                        text += `${date} ${desc}$${t.amount}\n`;
                        totalAmount += Number(t.amount);
                    } else {
                         text += `${date} [調整] ${t.note} ${t.amount>0?'+':''}${t.amount}\n`;
                         totalAmount -= Number(t.amount); // 調整項反向計算入"花費"
                    }
                });
                
                text += `----------------\n`;
                text += `本期新增消費：$${formatNumber(totalAmount)}\n`;
                text += `目前總結餘：$${formatNumber(currentBalance.value)}`;
                
                return text;
            });

            // 樣式輔助
            const currentTabName = computed(() => tabs.find(t => t.id === viewMode.value)?.name);
            const headerClass = computed(() => {
                if(viewMode.value === 'exception') return 'bg-amber-600';
                if(viewMode.value === 'copy') return 'bg-green-600';
                if(viewMode.value === 'products') return 'bg-gray-700';
                return 'bg-purple-700';
            });
            const getAmountColor = (t) => {
                if(t.type === 'deposit') return 'text-teal-600';
                if(t.type === 'exception') return t.amount >= 0 ? 'text-teal-600' : 'text-red-600';
                return 'text-red-600';
            };
            const getSign = (t) => {
                if(t.type === 'expense') return '-';
                if(t.type === 'deposit') return '+';
                return t.amount >= 0 ? '+' : '';
            };

            const getWeekDay = (dateStr) => ['(日)', '(一)', '(二)', '(三)', '(四)', '(五)', '(六)'][new Date(dateStr).getDay()];
            const formatNumber = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const formatDate = (dateStr) => {
                const d = new Date(dateStr);
                return `${d.getMonth() + 1}/${d.getDate()}`;
            };

            // 操作方法
            const openModal = (type) => {
                modalType.value = type;
                form.value = { date: new Date().toISOString().split('T')[0], small: 0, large: 0, amount: '', note: '' };
                showModal.value = true;
            };
            
            const getModalTitle = () => {
                if (modalType.value === 'expense') return '新增配送紀錄';
                if (modalType.value === 'deposit') return '新增儲值/轉帳';
                if (modalType.value === 'exception') return '新增例外調整';
            };

            const calculateExpense = () => (form.value.small * currentPrices.value.small) + (form.value.large * currentPrices.value.large);

            const submitTransaction = async () => {
                if (modalType.value === 'deposit' && !form.value.amount) return alert("請輸入金額");
                if (modalType.value === 'expense' && calculateExpense() === 0) return alert("請輸入數量");
                if (modalType.value === 'exception' && !form.value.note) return alert("例外調整必須填寫原因");

                const newTx = {
                    date: form.value.date,
                    type: modalType.value,
                    small: modalType.value === 'expense' ? form.value.small : 0,
                    large: modalType.value === 'expense' ? form.value.large : 0,
                    amount: modalType.value === 'expense' ? calculateExpense() : form.value.amount,
                    note: form.value.note
                };

                try {
                    await addDoc(collection(db, COLLECTION_NAME), newTx);
                    showModal.value = false;
                } catch (e) {
                    alert("錯誤: " + e.message);
                }
            };
            
            const deleteTransaction = async (id) => {
                if(confirm('確定要刪除這筆資料嗎？(刪除後無法復原)')) {
                    try {
                        await deleteDoc(doc(db, COLLECTION_NAME, id));
                    } catch(e) {
                        alert("刪除失敗");
                    }
                }
            };

            const importInitialData = async () => {
                if(!confirm(`確定導入歷史資料？`)) return;
                try {
                    const promises = initialData.map(data => addDoc(collection(db, COLLECTION_NAME), data));
                    await Promise.all(promises);
                    alert("導入成功！");
                } catch (e) { alert("導入失敗"); }
            };
            
            const copyToClipboard = () => {
                navigator.clipboard.writeText(unsettledText.value).then(() => alert("已複製到剪貼簿！"));
            };

            return {
                dbReady, transactions, sortedTransactions, exceptionTransactions, monthlyStats, currentBalance,
                viewMode, showModal, modalType, form, tabs, currentTabName, headerClass, unsettledText, currentPrices,
                getWeekDay, formatNumber, formatDate, getAmountColor, getSign, getModalTitle,
                openModal, calculateExpense, submitTransaction, importInitialData, deleteTransaction, copyToClipboard
            };
        }
    }).mount('#app');
</script>
</body>
</html>
